{% extends "admin/base.html" %}

{% block content %}
<h1>{{ 'Edit' if edit else 'Add' }} Event</h1>

<div class="card">
    <form method="POST" id="eventForm">
        <div class="form-group">
            <label>Title *</label>
            <input type="text" name="title" value="{{ event.title if event else '' }}" required>
        </div>
        
        <div class="form-group">
            <label>Description *</label>
            <textarea name="description" rows="4" required>{{ event.description if event else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label>Date *</label>
            <input type="date" name="date" value="{{ event.date.strftime('%Y-%m-%d') if event else '' }}" required>
        </div>
        
        <div class="form-group">
            <label>Event Type *</label>
            <select name="event_type" id="eventType" required>
                <option value="general" {{ 'selected' if event and event.event_type == 'general' else '' }}>General</option>
                <option value="codex" {{ 'selected' if event and event.event_type == 'codex' else '' }}>CodeX</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Cover Image URL *</label>
            <input type="url" name="cover_image" value="{{ event.cover_image if event else '' }}" required>
            <small style="color: #666;">Format: https://accesspicturescloud.vercel.app/events/event-name/cover.jpg</small>
        </div>
        
        <div id="codexFields" style="display: none;">
            <h3>CodeX Categories (3 categories, 3 winners each)</h3>
            {% for i in range(3) %}
            <div class="card" style="margin: 15px 0; padding: 15px; background: #f9f9f9;">
                <h4>Category {{ i + 1 }}</h4>
                <div class="form-group">
                    <label>Category Name *</label>
                    <input type="text" name="category_{{ i }}_name" 
                           value="{{ event.codex_categories[i].category_name if event and event.codex_categories and event.codex_categories|length > i else '' }}">
                </div>
                {% for j in range(3) %}
                <div style="margin-left: 20px; padding: 10px; border-left: 3px solid #ddd;">
                    <h5>Winner {{ j + 1 }} (Rank {{ j + 1 }})</h5>
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="category_{{ i }}_winner_{{ j }}_name" 
                               value="{{ event.codex_categories[i].winners[j].name if event and event.codex_categories and event.codex_categories|length > i and event.codex_categories[i].winners|length > j else '' }}">
                    </div>
                    <div class="form-group">
                        <label>Photo URL *</label>
                        <input type="url" name="category_{{ i }}_winner_{{ j }}_photo" 
                               value="{{ event.codex_categories[i].winners[j].photo_url if event and event.codex_categories and event.codex_categories|length > i and event.codex_categories[i].winners|length > j else '' }}">
                        <small style="color: #666;">Format: https://acsespicscloud.vercel.app/codex/month/winner-name.jpg</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        
        <div id="generalFields">
            <h3>Event Winners (Optional)</h3>
            <div id="winnersContainer">
                {% if event and event.winners %}
                    {% for winner in event.winners %}
                    <div class="card" style="margin: 10px 0; padding: 10px; background: #f9f9f9;">
                        <div class="form-group">
                            <label>Winner Name</label>
                            <input type="text" name="winner_{{ loop.index0 }}_name" value="{{ winner.name }}">
                        </div>
                        <div class="form-group">
                            <label>Position (e.g., 1st, 2nd, Winner)</label>
                            <input type="text" name="winner_{{ loop.index0 }}_position" value="{{ winner.position }}">
                        </div>
                        <div class="form-group">
                            <label>Photo URL</label>
                            <input type="url" name="winner_{{ loop.index0 }}_photo" value="{{ winner.photo_url }}">
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <input type="hidden" name="winner_count" id="winnerCount" value="{{ event.winners|length if event and event.winners else 0 }}">
            <button type="button" class="btn" onclick="addWinner()">+ Add Winner</button>
        </div>
        
        <h3>Event Photos</h3>
        <div id="eventPhotosContainer">
            {% if event and event.event_photos %}
                {% for photo in event.event_photos %}
                <div class="form-group">
                    <input type="url" name="event_photo_{{ loop.index0 }}" value="{{ photo }}">
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <input type="hidden" name="photo_count" id="photoCount" value="{{ event.event_photos|length if event and event.event_photos else 0 }}">
        <button type="button" class="btn" onclick="addEventPhoto()">+ Add Event Photo</button>
        
        <button type="submit" class="btn btn-success">{{ 'Update' if edit else 'Create' }}</button>
        <a href="{{ url_for('admin.events') }}" class="btn btn-danger">Cancel</a>
    </form>
</div>

<script>
function toggleCodexFields() {
    const eventType = document.getElementById('eventType').value;
    const codexFields = document.getElementById('codexFields');
    const generalFields = document.getElementById('generalFields');
    codexFields.style.display = eventType === 'codex' ? 'block' : 'none';
    generalFields.style.display = eventType === 'general' ? 'block' : 'none';
}

function addWinner() {
    const container = document.getElementById('winnersContainer');
    const count = parseInt(document.getElementById('winnerCount').value);
    const div = document.createElement('div');
    div.className = 'card';
    div.style.cssText = 'margin: 10px 0; padding: 10px; background: #f9f9f9;';
    div.innerHTML = `
        <div class="form-group">
            <label>Winner Name</label>
            <input type="text" name="winner_${count}_name">
        </div>
        <div class="form-group">
            <label>Position (e.g., 1st, 2nd, Winner)</label>
            <input type="text" name="winner_${count}_position" value="${count + 1}">
        </div>
        <div class="form-group">
            <label>Photo URL</label>
            <input type="url" name="winner_${count}_photo" placeholder="https://acsespicscloud.vercel.app/events/event-name/winner${count + 1}.jpg">
        </div>
    `;
    container.appendChild(div);
    document.getElementById('winnerCount').value = count + 1;
}

function addEventPhoto() {
    const container = document.getElementById('eventPhotosContainer');
    const count = parseInt(document.getElementById('photoCount').value);
    const div = document.createElement('div');
    div.className = 'form-group';
    div.innerHTML = `<input type="url" name="event_photo_${count}" placeholder="https://acsespicscloud.vercel.app/events/event-name/photo${count + 1}.jpg">`;
    container.appendChild(div);
    document.getElementById('photoCount').value = count + 1;
}

document.getElementById('eventType').addEventListener('change', toggleCodexFields);
window.addEventListener('DOMContentLoaded', toggleCodexFields);
</script>
{% endblock %}
